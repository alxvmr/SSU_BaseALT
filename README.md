# Сборка RPM-пакета из исходников Python (импортируемый модуль)
---
О настройке виртуального окружения (Poetry), сборе зависимостей и создании конфигурационного файла pyproject.toml + архитектура RPM-пакета (.gear/rules и .spec)

Демонстрация делалась на ОС **ALT Linux** :arrow_right::arrow_right::arrow_right: названия пакетов, .spec-файл и прочее специфичны и сопоставимы с этим дистрибутивом

---
# Содержание
- [Сборка RPM-пакета из исходников Python (импортируемый модуль)](#сборка-rpm-пакета-из-исходников-python-импортируемый-модуль)
- [Содержание](#содержание)
- [Poetry - инструмент для управления пакетами](#poetry---инструмент-для-управления-пакетами)
  - [Системные требования](#системные-требования)
  - [Установка](#установка)
  - [Создание проекта](#создание-проекта)
    - [С нуля](#с-нуля)
    - [Интеграция Poetry в существующий проект](#интеграция-poetry-в-существующий-проект)
  - [Создание виртуального окружения](#создание-виртуального-окружения)
    - [Зачем нужнго виртуальное окружение?](#зачем-нужнго-виртуальное-окружение)
  - [Подготовка виртуального окружения](#подготовка-виртуального-окружения)
  - [Добавление и удаление зависимостей](#добавление-и-удаление-зависимостей)
    - [Добавление](#добавление)
    - [Удаление](#удаление)
  - [Pyproject.toml](#pyprojecttoml)
- [Сборка в RPM-пакет](#сборка-в-rpm-пакет)
  - [%pyproject\_build](#pyproject_build)
  - [%pyproject\_install](#pyproject_install)
  - [Запуск сборки](#запуск-сборки)
  - [Установка](#установка-1)
- [Проверка](#проверка)
- [Дополнительная информация](#дополнительная-информация)


# Poetry - инструмент для управления пакетами

Poetry предоставляет возможность:
- управления зависимостями
- автоматического управления виртуальными окружениями
- сборки и публикации

В нашем случае, Poetry будет использоваться для создания проекта и виртуального окружения, а также как средство управления зависимостями

## Системные требования
:heavy_check_mark: Python 3.8+

:heavy_check_mark: ОС: Linux, macOS, Windows (в демонстрации используется ALT Linux)

## Установка
От пользователя `root`:

```bash
apt-get install python3-module-poetry
```

После проверяем корректность установки:

```bash
poetry --version
Poetry (version 1.4.0)
```

## Создание проекта
### С нуля
Для создания проекта с нуля в терминале нужно выполнить команду (находясь в директории, где планируется создание проекта):

```bash
poetry new <имя-проекта>
```

В итоге, Poetry создаст папку проекта со следующей структурой:
```bash
<имя-проекта>/
├── <имя-проекта>
│   └── __init__.py
├── pyproject.toml
├── README.md
└── tests
    └── __init__.py
```

Структуру можно изменять (+ следить за правильностью содержания pyproject.toml), но желательно придерживаться правила - исходный код проекта, который мы хотим добавить в сборку, должен лежать в директории `<имя-проекта>/<имя-проекта>/`

### Интеграция Poetry в существующий проект
Для использования Poetry в существующем проекте в терминале нужно выполнить:

```bash
cd <имя-проекта>
poetry init
```

Poetry задаст ряд вопросов, после ответа на которые сформируется конфигурационный файл `pyproject.toml`

## Создание виртуального окружения
### Зачем нужнго виртуальное окружение?
При ведении разработки в основном окружении возникают различные неудобства. Например, для одного проекта нужна одна версия библиотеки, для другого - другая. В следствие чего возникает конфликт - будет работать только один проект, поскольку в системе может находиться только одна из версий библиотек. Сюда же относится и использование различных версий Python.

Помимо описанного **конфликта зависимостей**, возникают также проблемы с **отслеживанием используемых библиотек** - среди общего списка установленных пакетов довольно сложно найти пакеты, относящиеся к проекту.

Также при **развертывании проекта на другой машине** возникают трудности - новое окружение отличается от исходного, в нем может не быть нужных зависимостей.

Все эти проблемы решаются созданием виртуального окружения - изолированной среды, в которой можно управлять зависимостями и библиотеками конкретного проекта.

## Подготовка виртуального окружения
Команды `new` и `init` не создают виртуальных окружений. 

При первом выполнении команд, связанных с установкой зависимостей, Poetry создает виртуальное окружение, выбрав базовый интерпретатор. 

Для указания корректной версии интерпретатора нужно выполнить команду:
```bash
poetry env use python3.9 # или другую имеющуюся в системе версию python
```

:warning: Чтобы **виртуальное окружение находилась в корне проекта** нужно выполнить команду:
```bash
poetry config virtualenvs.in-project true
```

Чтобы запустить оболочку с активированным виртуальным окружением нужно выполнить команду:
```bash
poetry shell
```
Вывод в консоли:

```bash
$ poetry shell
Spawning shell within <...>/.venv
. <...>/.venv/bin/activate

$ . <...>/.venv/bin/activate

calc-py3.9[alekseevamo@lenovo-93812 rpm]$ 
```

В итоге, оболочка запустилась, слева появилось название оболочки с активированным окружением - `calc-py3.9`

## Добавление и удаление зависимостей
### Добавление
В созданное "чистое", виртуальное окружение можно устанавливать пакеты при помощи команды `add`:
```
poetry add <имя-пакета>
```

Например:
```
poetry add emoji
```

После чего в секции ` [tool.poetry.dependencies]` файла `pyproject.toml` появится зависимость:
```
[tool.poetry.dependencies]
python = "^3.9"
emoji = "^2.12.1"
```

### Удаление
Для удаления пакетов используется команда:
```
poetry remove <имя-пакета>
```

## Pyproject.toml
`pyproject.toml` - конфигурационный файл, содержащий мета-информацию о проекте. Используется как файл конфигурации для инструментов, связанных с упаковкой (и для других)

Помимо этого, файл используется в сборке RPM-пакетов, автоматизируя сборочный процесс.

Пример файла можно найти в корне репозитория.

# Сборка в RPM-пакет
После того, как был написан pyproject.toml можно перейти к сборке RPM-пакета.

Спецификации для сборки пакета описываются в файле `<имя-проекта>.spec`, в файле `.gear/rules` описывается правила для упаковки архива (для `gear`). Данные файлы для демонстрационного проекта можно найти в репозитории.

В пакетной базе Sisyphus есть пакет `rpm-build-python3`, предоставляющий макросы RPM, которые на основе pyproject.toml производят сборку пакета:
- `%pyproject_build` - для сборки проекта
- `%pyproject_install` - для установки пакета
- и другие макросы, которые не будут использованы в текущем примере

> [!NOTE]
> Чтобы вычислить значение макроса, можно использовать команду `rpm --eval <имя-макроса>`

В результате сборки, получим правильное расположение файлов проекта в системе и все необходимые зависимости

## %pyproject_build
Выполняет `pyproject_installer -v build`
В результате создается `wheel` (`zip` архив), который будет помещен в `<source-directory>/dist/`

## %pyproject_install
Выполняет 
```
pyproject_installer -v install --destdir=/tmp/.private/<user-name>/%{name}-buildroot
```
В основном, установщик проверяет содержимое `wheel`, распаковывает его и при необходимости размещает распакованные файлы. 

## Запуск сборки
> [!WARNING]
> Предварительно требуется подготовка рабочего пространства для сборки RPM-пакетов и настройка Hasher

Производить сборку будем в чистой и контролируемой среде при помощи инструмента `hasher`. Это возможно из-за создания в chroot минимальной сборочной среды, установки туда указанных в source-пакете сборочных зависимостей и сборке пакета в свежесозданной среде.

Для сборки `hasher` нужно выполнить команду:
```
gear-hsh ~/.hasher -v --no-sisyphus-check
```

Подробнее о Hasher можно посмотреть в дополнительной информации.

## Установка
После успешной сборки пакета должны появиться файлы:
`~/.hasher/repo/SRPMS.hasher/calc-0.1.0-alt1.src.rpm`
`~/.hasher/repo/x86_64/RPMS.hasher/calc-0.1.0-alt1.noarch.rpm`

Их необходимо установить в систему командами:
```
rpm -Uvh ~/.hasher/repo/SRPMS.hasher/calc-0.1.0-alt1.src.rpm
rpm -Uvh ~/.hasher/repo/x86_64/RPMS.hasher/calc-0.1.0-alt1.noarch.rpm
```

# Проверка
В результате мы получили в системе новый пакет - `calc-0.1.0-alt1`. Он предоставляет импортируемый python-модуль. 

Проверим его работоспособность. В терминале выполним:

```
[alekseevamo@lenovo-93812 ~]$ python3
Python 3.9.18 (main, Feb 17 2024, 05:09:41) 
[GCC 10.3.1 20210703 (ALT Sisyphus 10.3.1-alt2)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from calc.calc import show_answer
>>> show_answer('5+5')
👇 Answer is 👇
10
>>> 
```

# Дополнительная информация
Мы рассмотрели базовую сборку RPM-пакета с Python-исходниками. Дополнителную информацию можно найти по ссылкам:

:link: [Документация  Poetry](https://python-poetry.org/)

:link: [Спецификация pyproject.toml](https://packaging.python.org/en/latest/specifications/pyproject-toml/)

:link: [Статья Poetry: from zero to hero](https://habr.com/ru/articles/740376/)

:link: [Python packaging guide (ALT Linux Wiki)](https://www.altlinux.org/Python_packaging_guide)

:link: [Руководство по сборке RPM-пакетов (подготовка окружения, необходимые пакеты)](https://alt-packaging-guide.github.io/)

:link: [Настройка Hasher](https://www.basealt.ru/fileadmin/user_upload/manual/ALT_Platform_guide.pdf)

:link: [Репозиторий Sisyphus - можно подсмотреть .spec файлы](https://packages.altlinux.org/ru/sisyphus/)
